#TODO: make the game work, make the pile draw correctly

par(bg = "navajowhite")
cards <- list() #all cards, shuffles
deck <- list() #draw pile
stack <- list() #play pile
wildcard <- 0 #wildcard
drawCount <- 0 #+2 and +4
selected <- 0
pause <- FALSE
menu <- 0
win <- TRUE
turnorder <- c(1, 1, FALSE) #player, direction, move played
click <- list(x = 3, y = 3)
textboxes <- list(0,0)
options <- c(0, 0, 0, 0)
# Variants:
#     Crazy Eights(standard deck, no power cards, score based)
#     Last Card(standard deck, power cards, shedding wins)
#     One(unique deck, power cards, shedding wins)
#     Other One(unique deck, power cards, can challenge +4, shedding wins)
# Queen Swap: (only for Crazy Eights)
#     Playing a queen causes a player to skip their turn
# 0's and 7's (only for One and Other One)
#     Playing a 7 allows the player to swap hands with someone else
#     Playing a 0 swaps all hands one over by turn order.
# AI or Human opponents
# Number of players
hands <- matrix()
stVals <- c("1","2","3","4","5","6","7","8","9","J","Q","K","A")
uqVals <- c("0","1","2","3","4","5","6","7","8","9","T","S","R","C","F")
suits <- c("♥", "♦", "♠", "♣")
variants <- c("Crazy Eights", "Last Card", "One", "Other One")
suitColors <- c("red", "red", "black", "black")
primaryColors <- c("red","yellow", "limegreen", "blue")
oneColors <- c("#ff0077","#ffaa00", "#448800", "#0066ff")

#functions, reset cards

unpack <- function() {
  for(i in 1:4)
  if(options[1]<2) {
    for(j in 1:13)
      cards <- c(cards, list(list(i,stVals[j])))
    if(options[4]>3)
      for(j in 1:13)
        cards <- c(cards, list(list(i,stVals[j])))
  } else {
    for(j in 1:15)
      cards <- c(cards, list(list(i,uqVals[j])))
    for(j in 2:13)
      cards <- c(cards, list(list(i,uqVals[j])))
  }
  return(cards)
}

dispCard <- function(x, y, card) {
  suit <- card[[1]][[1]]
  valu <- card[[1]][[2]]
  rect(x,y,x+1,y+2, col="white", border="black")
  if(options[1]<2) { #colors/cards
    text(x+0.5,y+1.5, suits[suit], col=suitColors[suit])
  } else {
    if(options[1]==2)
      rect(x,y+1,x+1,y+2, col=oneColors[suit], border="black")
    else
      rect(x,y+1,x+1,y+2, col=primaryColors[suit], border="black")
  }
  
  if(valu == "T"){ #face values
    text(0.5+x,0.5+y, "+2")
  } else if(valu == "S"){
    text(0.5+x,0.5+y, "(X)")
  } else if(valu == "R"){
    text(0.5+x,0.5+y, "<>")
  } else if(valu == "C"){
    rect(x,y+1,x+1,y+2, col="gray12", border="black")
    text(0.5+x,0.5+y, " ")
  } else if(valu == "F"){
    rect(x,y+1,x+1,y+2, col="gray12", border="black")
    text(0.5+x,0.5+y, "+4")
  } else {
    text(0.5+x,0.5+y, valu)
  }
}

wildColor <- function() {
  rect(0,0,10,3, col="#a52a2a80", border="transparent")
  while(TRUE){
    dispCard(1, 1, list(list(1, " ")))
    dispCard(3, 1, list(list(2, " ")))
    dispCard(5, 1, list(list(3, " ")))
    dispCard(7, 1, list(list(4, " ")))
    click <- locator(1)
    if(floor(click$x) < 2)
      return(1)
    if(floor(click$x) < 4)
      return(2)
    if(floor(click$x) < 6)
      return(3)
    if(floor(click$x) < 8)
      return(4)
  }
}

validCard <- function(card) {
  suit <- card[[1]][[1]]
  valu <- card[[1]][[2]]
  return( (suit == stack[[length(stack)]][[1]][[1]] && !wildcard) || valu == stack[[length(stack)]][[1]][[2]] || valu == "C" ||
          valu == "F" || (options[1]==0 && valu== "8") || (options[1]==1 && valu== "A") || (options[1]==1 && valu== "J") || (wildcard && suit == wildcard))
}

doAI <- function() {
  while(turnorder[2]!=1){
    
   nextPlayer() 
  }
}

nextPlayer <- function() {
  if(turnorder[1])
    return((turnorder[2] %% (options[4]+2)) + 1)
  return(((turnorder[2]-2) %% (options[4]+2)) + 1)
}

#menu
plot(0, 0, type = "n", xlim = c(0, 9), ylim = c(0, 9), col="white", xlab = "by slimestew", ylab = "", axes = FALSE, frame.plot = TRUE)
par(bg = "navajowhite")
text(5,5, "Crazy Eights (for R)")

while((floor(click$y) < 5 || floor(click$y) > 8) || menu < 2){
  click <- locator(1)
  plot(0, 0, type = "n", xlim = c(0, 9), ylim = c(0, 9), xlab = "", ylab = "", axes = FALSE, frame.plot = FALSE)
  
  if((floor(click$x) > 1 && floor(click$x) < 7) && menu > 0){
    if(floor(click$y) == 3)
      options[1] <- (options[1]+1) %% 4
    if(floor(click$y) == 2)
      options[2] <- !options[2]
    if(floor(click$y) == 1)
      options[3] <- !options[3]
    if(floor(click$y) == 0)
      options[4] <- (options[4]+1) %% 6
  }
  
  rect(1, 5, 7, 6, col = "tan", border = "brown")
  rect(1, 3, 7, 4, col = primaryColors[options[1]+1], border = "black")
  rect(1, 2, 7, 3, col = primaryColors[options[2]+1], border = "black")
  rect(1, 1, 7, 2, col = primaryColors[options[3]+1], border = "black")
  rect(1, 0, 7, 1, col = "white", border = "black")
  text(4,8, "Crazy Eights")
  text(4,3.5, variants[options[1]+1])
  text(4,2.5, ifelse(options[1]<2, ifelse(options[1]," ","Queen Skip"),"0s and 7s"))
  text(4,1.5, ifelse(options[3],"AI","Human"))
  text(4,0.5, options[4]+2)
  text(4,5.5, "Start")
  
  menu <- min(menu + 1,2)
}

plot(0, 0, type = "n", xlim = c(0, 10), ylim = c(0, 10), col="white", xlab = "", ylab = "", axes = FALSE, frame.plot = TRUE)
menu <- 0

cards <- sample(unpack(), replace=TRUE)
deck <- cards
hands <- replicate(options[4]+2, list())
for(i in 1:(options[4]+2)){
  hand<-7
  if(options[1]<2 && options[4] != 0)
    hand<-5
  
  for(j in 1:hand){
    temp <- sample(length(deck), 1)
    hands[[i]] <- c(hands[[i]], list(deck[temp][1]))
    deck <- deck[-temp]
  }
}
temp <- sample(length(deck), 1)
stack <- list(deck[temp][1])
deck <- deck[-temp]

# add card
hands[[1]] <- c(hands[[1]], list(list(list(1,"8"))))

#game loop
while(win) {

if(menu>0){
  if(floor(click$x) > 0 && floor(click$x) < 9 && floor(click$y) > -1 && floor(click$y) < 3) #selection
    selected <- floor(click$x)
  
  if(floor(click$x) > 4 && floor(click$x) < 6 && floor(click$y) > 3 && floor(click$y) < 6 && selected[1]){ #play card
    if(validCard(hands[[turnorder[2]]][[selected]])){
      stack <- c(stack, list(hands[[turnorder[2]]][[selected]]))
      hands[[turnorder[2]]] <- hands[[turnorder[2]]][-selected]
      if(wildcard)
        wildcard <- 0
      turnorder[3] <- TRUE
      selected <- -1
    } else {
      selected <- 0
    }
  }
    
  if(floor(click$x) > 2 && floor(click$x) < 5 && floor(click$y) > 3 && floor(click$y) < 5){ #draw card
    hands[[turnorder[2]]] <- c(hands[[turnorder[2]]], list(deck[length(deck)][1]))
    deck <- deck[-length(deck)]
    selected <- -1
  }
  
  if(length(hands[[turnorder[2]]]) == 0)
    win <-FALSE
  
  if(selected == -1 && win){  #do actions if game isnt over
    if(turnorder[3])
      if(options[1] == 0){ #crazy eights
        if(stack[[length(stack)]][[1]][[2]] == "8")
          wildcard <- wildColor()
        if(stack[[length(stack)]][[1]][[2]] == "Q" && options[2])
          turnorder[2] <- nextPlayer()
      } else if(options[1] == 1){
        if(stack[[length(stack)]][[1]][[2]] == "8")
          turnorder[2] <- nextPlayer()
        if(stack[[length(stack)]][[1]][[2]] == "J")
          wildcard <- wildColor()
        if(stack[[length(stack)]][[1]][[2]] == "2")
          drawCount <- drawCount+2
        if(stack[[length(stack)]][[1]][[2]] == "A"){
          drawCount <- drawCount+4
          wildcard <- wildColor()
        }
      } else if(options[1] >= 2){
        if(stack[[length(stack)]][[1]][[2]] == "S")
          turnorder[2] <- nextPlayer()
        if(stack[[length(stack)]][[1]][[2]] == "R")
          turnorder[1] <- !turnorder[1]
        if(stack[[length(stack)]][[1]][[2]] == "C")
          wildcard <- wildColor()
        if(stack[[length(stack)]][[1]][[2]] == "T")
          drawCount <- drawCount+2
        if(stack[[length(stack)]][[1]][[2]] == "F"){
          drawCount <- drawCount+4
          wildcard <- wildColor()
        }
      }
    
    if(!options[3])
      pause <-TRUE
    turnorder[2] <- nextPlayer()
    selected <- 0
  }
  
  if(options[3])
    doAI()
}
  
plot(0, 0, type = "n", xlim = c(0, 10), ylim = c(0, 10), xlab = ifelse(options[1]==0,paste("Score:",textboxes),""), ylab = "", axes = FALSE, frame.plot = FALSE)
rect(0,4.5,10,6.5, col="darkorange4", border="black")
rect(0,-2,10,6, col="brown", border="black")

if(!pause){
  
  for(i in floor(length(deck)/8):1) #todo: make this fall properly
    rect(3,4-(i*0.1),5,5-(i*0.1), col="chartreuse4", border="black")
  rect(3,4,5,5, col="chartreuse3", border="black")
  rect(3.25,4.25,4.75,4.75, col="chartreuse4", border="white") 
  
  for(i in 1:(options[4]+1)){
    rect(1+i,8,2+i,10, col="chartreuse3", border="black")
    rect(1.25+i,8.25,1.75+i,9.75, col="chartreuse4", border="white")
    if(i>=turnorder[2]+1){
      text(1.5+i, 7.5, length(hands[[i]]))
    } else {
      text(1.5+i, 7.5, length(hands[[i+1]]))
    }
  }
  if(wildcard){
    if(options[1]<2){ #colors/cards
      symbols(6.5, 5, circles = 0.5, inches = FALSE, add = TRUE, bg = "white", fg="brown")
      text(6.5,5, suits[wildcard], col=suitColors[wildcard])
    } else {
      if(options[1]==2){
        symbols(6.5, 5, circles = 0.5, inches = FALSE, add = TRUE, bg = oneColors[wildcard], fg="brown")
      } else {
        symbols(6.5, 5, circles = 0.5, inches = FALSE, add = TRUE, bg = primaryColors[wildcard], fg="brown")
      }
    }
  }
  dispCard(5, 4, stack[[length(stack)]])
    
  if(win)
    for(i in 1:length(hands[[turnorder[2]]])) #display cards(how to order? spaced out if few, navbars if many)
      dispCard(i, (selected==i), hands[[turnorder[2]]][[i]])

} else {
  text(4,4, paste("Click for Player",turnorder[2]))
  menu <- -1
}

menu <- min(menu+1, 1)

click <- locator(1)

if(pause)
  pause <- FALSE
}
if(!options[3] || (length(hands[[1]]) == 0 && options[3])){
  text(5,3, "You win!")
} else {
  text(5,3, "Game Over")
}